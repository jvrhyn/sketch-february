---
import SketchLayout from '../../layouts/SketchLayout.astro';
---

<SketchLayout
  title="kanisza icosahedron"
  day={1}
  description="click and drag to rotate"
>
  <script is:inline>
    let angleX = 0.24;
    let angleY = 0.14;
    let velocityX = 0;
    let velocityY = 0;
    let vertices = [];
    let faces = [];
    let edges = [];
    let isDragging = false;
    let lastMouseX, lastMouseY;
    const friction = 0.95;
    const circleRadius = 40;
    const edgeWidth = 12;

    function setup() {
      const canvas = createCanvas(600, 600);
      canvas.parent('sketch-container');

      // Golden ratio
      const phi = (1 + Math.sqrt(5)) / 2;
      const scale = 150;

      // 12 vertices of icosahedron
      vertices = [
        createVector(-1,  phi, 0),
        createVector( 1,  phi, 0),
        createVector(-1, -phi, 0),
        createVector( 1, -phi, 0),
        createVector(0, -1,  phi),
        createVector(0,  1,  phi),
        createVector(0, -1, -phi),
        createVector(0,  1, -phi),
        createVector( phi, 0, -1),
        createVector( phi, 0,  1),
        createVector(-phi, 0, -1),
        createVector(-phi, 0,  1)
      ];

      for (let v of vertices) {
        v.normalize().mult(scale);
      }

      // 20 triangular faces
      faces = [
        [0, 11, 5], [0, 5, 1], [0, 1, 7], [0, 7, 10], [0, 10, 11],
        [1, 5, 9], [5, 11, 4], [11, 10, 2], [10, 7, 6], [7, 1, 8],
        [3, 9, 4], [3, 4, 2], [3, 2, 6], [3, 6, 8], [3, 8, 9],
        [4, 9, 5], [2, 4, 11], [6, 2, 10], [8, 6, 7], [9, 8, 1]
      ];

      // Build unique edges from faces
      let edgeSet = new Set();
      for (let face of faces) {
        for (let i = 0; i < 3; i++) {
          let a = face[i];
          let b = face[(i + 1) % 3];
          let key = a < b ? `${a}-${b}` : `${b}-${a}`;
          edgeSet.add(key);
        }
      }
      edges = Array.from(edgeSet).map(k => k.split('-').map(Number));
    }

    function rotateVertex(v, ax, ay) {
      let x = v.x, y = v.y, z = v.z;

      let cosY = cos(ay), sinY = sin(ay);
      let x1 = x * cosY - z * sinY;
      let z1 = x * sinY + z * cosY;

      let cosX = cos(ax), sinX = sin(ax);
      let y2 = y * cosX - z1 * sinX;
      let z2 = y * sinX + z1 * cosX;

      return createVector(x1, y2, z2);
    }

    function draw() {
      if (isDragging) {        
        velocityY = (mouseX - lastMouseX) * 0.01;
        velocityX = (mouseY - lastMouseY) * 0.01;
        lastMouseX = mouseX;
        lastMouseY = mouseY;
      } else {
        velocityX *= friction;
        velocityY *= friction;
        
      }

      angleY += velocityY;
      angleX += velocityX;

      background(255);
      translate(width / 2, height / 2);

      // Transform vertices
      let transformed = vertices.map(v => rotateVertex(v, angleX, angleY));

      // Draw black circles at each vertex
      fill(0);
      noStroke();
      for (let v of transformed) {
        ellipse(v.x, v.y, circleRadius * 2);
      }

      // Draw edges as white lines, extended to meet properly
      stroke(255);
      strokeWeight(edgeWidth);
      strokeCap(SQUARE);
      for (let [a, b] of edges) {
        let v1 = transformed[a];
        let v2 = transformed[b];

        // Extend line past vertices so edges meet
        let dx = v2.x - v1.x;
        let dy = v2.y - v1.y;
        let len = sqrt(dx * dx + dy * dy);
        let extend = circleRadius * 0.07;
        let ex = (dx / len) * extend;
        let ey = (dy / len) * extend;

        line(v1.x - ex, v1.y - ey, v2.x + ex, v2.y + ey);
      }
    }

    function mousePressed() {
      isDragging = true;
      lastMouseX = mouseX;
      lastMouseY = mouseY;
    }

    function mouseReleased() {
      isDragging = false;
    }
  </script>
</SketchLayout>
